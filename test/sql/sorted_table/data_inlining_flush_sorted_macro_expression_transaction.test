# name: test/sql/sorted_table/data_inlining_flush_sorted_macro_expression_transaction.test
# description: Sort by a DuckLake macro to approximate space filling curve sorting within a transaction
# group: [sorted_table]

require ducklake

require parquet


test-env DUCKLAKE_CONNECTION __TEST_DIR__/{UUID}.db


statement ok
ATTACH 'ducklake:${DUCKLAKE_CONNECTION}' AS ducklake (DATA_PATH '__TEST_DIR__/merge_adjacent_sorted_macro_expression_transaction/', DATA_INLINING_ROW_LIMIT 10)

statement ok
USE ducklake;

# Create a table with a unique_id column for nested expression sorting
statement ok
CREATE TABLE macro_sort_test (i VARCHAR, j VARCHAR);

statement ok
INSERT INTO macro_sort_test 
SELECT 'ZYX' AS i, 'CBA' AS j 
UNION ALL 
SELECT 'ABC' AS i, 'XYZ' AS j 
UNION ALL
SELECT '321' AS i, '000' AS j 
UNION ALL 
SELECT '123' AS i, '000' AS j 


statement ok
BEGIN

statement ok
CREATE MACRO zip_varchar(i, j, num_chars := 6) AS (
    -- By default using 6 characters from each string so that
    -- if data is ASCII, we can fit it all in 12 bytes so that it is stored inline
    -- rather than requiring a pointer
    [
	   list_value(z[1], z[2])
	   FOR z
	   IN list_zip(
		  substr(i, 1, num_chars).rpad(num_chars, ' ').string_split(''),
		  substr(j, 1, num_chars).rpad(num_chars, ' ').string_split('')
	   )
    ].flatten().array_to_string('')
);

# Test that the macro is working as intended independently of sorting
query III
SELECT
    'ABC' AS i,
    'XYZ' AS j,
    zip_varchar(i, j, num_chars := 3) AS zipped_varchar;
----
ABC	XYZ	AXBYCZ

# Set sorted 
statement ok
ALTER TABLE ducklake.macro_sort_test SET SORTED BY (zip_varchar(i, j, num_chars := 3) ASC NULLS LAST);

# Verify data before inline flush (should be in insertion order)
query III
SELECT i, j, zip_varchar(i, j, num_chars := 3)
FROM macro_sort_test
----
ZYX	CBA	ZCYBXA
ABC	XYZ	AXBYCZ
321	000	302010
123	000	102030

statement ok
CALL ducklake_flush_inlined_data('ducklake', table_name => 'macro_sort_test');

# Verify data is now sorted by the macro
query III
SELECT i, j, zip_varchar(i, j, num_chars := 3)
FROM macro_sort_test
----
123	000	102030
321	000	302010
ABC	XYZ	AXBYCZ
ZYX	CBA	ZCYBXA

# We can even clear the sorting before committing
statement ok 
ALTER TABLE ducklake.macro_sort_test RESET SORTED BY

statement ok
COMMIT

# Verify data is still sorted by the macro
query III
SELECT i, j, zip_varchar(i, j, num_chars := 3)
FROM macro_sort_test
----
123	000	102030
321	000	302010
ABC	XYZ	AXBYCZ
ZYX	CBA	ZCYBXA

statement ok
DROP MACRO zip_varchar

