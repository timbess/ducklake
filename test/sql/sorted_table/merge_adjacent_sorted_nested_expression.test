# name: test/sql/sorted_table/merge_adjacent_sorted_nested_expression.test
# description: test ducklake merge adjacent files with SET SORTED BY using a nested expression
# group: [sorted_table]

require ducklake

require parquet

test-env DUCKLAKE_CONNECTION __TEST_DIR__/{UUID}.db

statement ok
ATTACH 'ducklake:${DUCKLAKE_CONNECTION}' AS ducklake (DATA_PATH '__TEST_DIR__/merge_adjacent_sorted_nested_expression/')

statement ok
USE ducklake;

# Create a table with a unique_id column for nested expression sorting
statement ok
CREATE TABLE sort_nested_expr_test (unique_id BIGINT, name VARCHAR);

statement ok
INSERT INTO sort_nested_expr_test (unique_id, name)
VALUES
    (1, 'one'),
    (2, 'two'),
    (3, 'three'),
    (4, 'four');

statement ok
INSERT INTO sort_nested_expr_test (unique_id, name)
VALUES
    (5, 'five'),
    (6, 'six'),
    (7, 'seven'),
    (8, 'eight');

# Verify we have 2 data files before compaction
query II
SELECT df.data_file_id, df.table_id
FROM __ducklake_metadata_ducklake.ducklake_data_file df
JOIN __ducklake_metadata_ducklake.ducklake_table t
ON df.table_id = t.table_id
WHERE
t.table_name = 'sort_nested_expr_test'
----
0	1
1	1

# Set sorted by a nested expression: concat(substr(power(unique_id, unique_id)::varchar, 1, 1), name)
statement ok
ALTER TABLE ducklake.sort_nested_expr_test SET SORTED BY (concat(substr(power(unique_id, unique_id)::varchar, 1, 1), name) ASC NULLS LAST);

# Verify data before compaction (should be in insertion order)
query III
SELECT unique_id, name, concat(substr(power(unique_id, unique_id)::varchar, 1, 1), name) AS sort_key
FROM sort_nested_expr_test
----
1	one	1one
2	two	4two
3	three	2three
4	four	2four
5	five	3five
6	six	4six
7	seven	8seven
8	eight	1eight

# Compact the files
statement ok
CALL ducklake_merge_adjacent_files('ducklake', 'sort_nested_expr_test');

# Verify we have 1 data file after compaction
query II
SELECT df.data_file_id, df.table_id
FROM __ducklake_metadata_ducklake.ducklake_data_file df
JOIN __ducklake_metadata_ducklake.ducklake_table t
ON df.table_id = t.table_id
WHERE
t.table_name = 'sort_nested_expr_test'
----
2	1

# Verify data is now sorted by the nested expression
query III
SELECT unique_id, name, concat(substr(power(unique_id, unique_id)::varchar, 1, 1), name) AS sort_key
FROM sort_nested_expr_test
----
8	eight	1eight
1	one	1one
4	four	2four
3	three	2three
5	five	3five
6	six	4six
2	two	4two
7	seven	8seven
